# Description: LibreOffice is a powerful office suite
# URL: https://www.libreoffice.org/
# Maintainer: crux libreoffice team, tbier at posteo dot de
# Depends on: avahi clucene coin-or-mp cups dconf fakeroot fontforge gpgme graphite2 gst-plugins-base gtk gtk3 harfbuzz-icu hunspell hyphen krb5 libabw libcdr libcmis libe-book libepubgen libetonyek libexttextcat libfreehand libmspub libmwaw libmythes libnumbertext libodfgen liborcus libpagemaker libqxp libstaroffice libtommath libvisio libwebp libwpg libwps libzmf lpsolve neon poppler redland sane xmlsec zip

name=libreoffice
version=6.3.0.2
release=1
source=(
http://downloadarchive.documentfoundation.org/libreoffice/old/$version/src/$name-$version.tar.xz
makefile.in.patch
)

build() {
  cd $name-$version
  patch -Np0 -i ../makefile.in.patch

  find -L . \
     \( -perm 777 -o -perm 775 -o -perm 750 -o -perm 711 -o -perm 555 \
     -o -perm 511 \) -exec chmod 755 {} \; -o \
     \( -perm 666 -o -perm 664 -o -perm 640 -o -perm 600 -o -perm 444 \
     -o -perm 440 -o -perm 400 \) -exec chmod 644 {} \;

  build_date=$(date +%Y%m%d)
  ./autogen.sh --prefix=/usr \
    --enable-{build-opensymbol,dbus,firebird-sdbc=no,gtk3,introspection=yes,release-build,odk,openssl,python=system} \
    --with-{lang="",package-format=archive,myspell-dicts,parallelism} \
    --with-build-version="$name-$version" \
    --with-extra-buildid="$(crux | awk '{ print $1 " " $3 }') ${build_date}" \
    --with-package-version="$version" \
    --with-system-{headers,libs} \
    --without-{doxygen,fonts,gssapi,help,helppack-integration,java,system-firebird} \
    --disable-{extension-update,dconf,firebird-sdbc,gstreamer-0-10,postgresql-sdbc,report-builder,sdremote-bluetooth,werror}
  touch sources.ver
  echo "lo_sources_ver=${version}" > sources.ver
  make build-nocheck

  pushd workdir/installation/LibreOffice/archive/install/en-US
  tar xf *.tar.gz
  popd

  make DESTDIR=$PKG distro-pack-install

  install -dm755 $PKG/usr/etc/libreoffice
  install -m644 $PKG/usr/lib/libreoffice/program/{bootstraprc,sofficerc} \
    $PKG/usr/etc/libreoffice/
  install -m644 $PKG/usr/lib/libreoffice/share/psprint/psprint.conf \
    $PKG/usr/etc/libreoffice/

  # install dummy links to make them found by lo
  cd $PKG/usr/lib/libreoffice/program/
  ln -vsrf $PKG/usr/etc/libreoffice/{bootstraprc,sofficerc} .

  # cleanup
  rm -fr $PKG/usr/share/libreoffice/sdk
  rm -fr $PKG/usr/share/doc
  find $PKG -iname "*readme*" -exec rm -fr '{}' \+
}
